#!/bin/bash
# Generated by `bmg backup`
# Docs: https://github.com/riotkit-org/br-backup-maker

set -eu

DB_NAME="{{ .Params.db }}"

COMMAND="mysqldump --skip-lock-tables --add-drop-table --add-drop-database --add-drop-trigger -h '{{ .Params.hostname }}' -u '{{ .Params.user }}' -p{{ .Params.password }} -P '{{ .Params.port }}'"

if [[ "${DB_NAME}" != "" ]]; then
    COMMAND="${COMMAND} ${DB_NAME}"
else
    COMMAND="${COMMAND} --all-databases"
fi

COMMAND="${COMMAND} | sed -e 's/DEFINER[ ]*=[ ]*[^*]*\*/\*/'"

export BM_AUTH_TOKEN="{{ .Repository.token }}";
export BM_COLLECTION_ID="{{ .Repository.collectionId }}";
export BM_PASSPHRASE="{{ .Repository.passphrase }}";

echo " >> Executing backup command and uploading piped result"

exec backup-maker make --url "{{ .Repository.url }}" \
    -c "${COMMAND}" \
    --key {{ .Repository.encryptionKeyPath }} \
    --recipient {{ .Repository.recipient }}\
    --log-level info
